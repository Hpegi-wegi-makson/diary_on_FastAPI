# Полный разбор проекта: архитектура, эндпоинты и сценарии

Этот документ — «полная карта проекта». Он помогает быстро вспомнить, что где лежит, как всё работает и как это объяснять на интервью.

---

## 1) Что это за проект

Backend‑сервис на FastAPI для задач (tasks) с регистрацией, JWT‑аутентификацией и ролевыми разрешениями (RBAC).

**Ключевые функции:**
- регистрация пользователя;
- логин по email/паролю;
- access + refresh токены;
- роли и права доступа;
- CRUD задач;
- фильтрация/пагинация задач.

---

## 2) Структура проекта

```
newboock_main/
├── main.py          # все эндпоинты FastAPI
├── database.py      # SQLAlchemy модели + DB сессия
├── jwt_manager.py   # создание/валидация JWT
├── permissions.py   # RBAC‑проверки
├── schemas.py       # Pydantic‑схемы
├── config.py        # настройки (ключи, роли)
├── шаблоны/ # HTML-шаблоны
└── static/          # CSS стили
```

---

## 3) Модели данных (SQLAlchemy)

### Пользователь (`User`)
Поля:
- `id`
- `email`
- `password` (хэш)
- `permissions` (строка через запятую)

Связь:
- `User.tasks` → список задач пользователя.

### Задача (`Task`)
Поля:
- `id` , `title` , `description`
- `due_date` , `is_done`
- `created_at`
- `owner_id` → пользователь

### Токен обновления (`RefreshToken`)
Поля:
- `token_hash` (хэш)
- `user_id`
- `expires_at`
- `revoked_at`
- `created_at`

Храним не сам токен, а только хэш.

---

## 4) Аутентификация JWT

Есть два типа токенов:
- **Access** (короткий срок жизни, доступ к эндпоинтам)
- **Refresh** (дольше живёт, нужен для обновления access)

В токен добавляется поле `type`, чтобы различать их назначение.

---

## 5) Эндпоинты

### Регистрация
`POST /registration`

Создаёт пользователя и даёт ему базовые permissions.

---

### Авторизоваться
`POST /login`

Возвращает:
```
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer"
}
```

Refresh‑токен сохраняется в БД.

---

### Обновление токена
`POST /token/refresh`

Принимает refresh‑токен и возвращает новую пару токенов.
Старый refresh становится отозванным.

---

### Выход
`POST /logout`

Отзывает refresh‑токен → повторный refresh не сработает.

---

### Текущий пользователь
`GET /me`

Возвращает id, email и permissions.

---

### CRUD задач
`POST /tasks`
`GET /tasks`
`GET /tasks/{task_id}`
`PATCH /tasks/{task_id}`
`DELETE /tasks/{task_id}`

Каждый эндпоинт проверяет permissions.

---

## 6) Разрешения и роли

В `config.py`:
- `user`: базовые права на задачи
- `moderator`: примерные права на удаление комментариев
- `admin`: полный доступ (`*`)

В `permissions.py` реализовано:
```
check_permission("task.read")
```
Если нет нужного разрешения → 403.

---

## 7) Тестирование

Тесты используют:
- `pytest`
- SQLite в оперативной памяти
- TestClient FastAPI

Проверяется сценарий refresh‑токенов:
```
регистрация → вход → обновление → выход → обновление (401)
```

---

## 8) Как объяснить проект на интервью (коротко)

«Я сделал backend на FastAPI с JWT‑аутентификацией и системой permissions.
У меня есть access‑токен для запросов, refresh‑токен для продления сессии.
Refresh хранится в БД в виде хэша, поэтому можно отзывать токены.
Есть CRUD задач и фильтрация, а доступ контролируется через RBAC.»

---

## 9) Что можно добавить дальше

1. PostgreSQL + Alembic миграции
2. JWT refresh rotation на несколько устройств
3. Redis для blacklist токенов
4. CI/CD (GitHub Actions)
5. Docker‑окружение
6. Логи + мониторинг