<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Navbook - Мои задачи</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }
    
    .task-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .task-table th {
      text-align: left;
      padding: 12px 16px;
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      color: var(--accent);
      font-weight: 600;
    }
    
    .task-table td {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: middle;
    }
    
    .task-table tr:hover {
      background: #f8fafc;
    }
    
    .inline-form {
      display: inline-block;
      margin-left: 8px;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }
    
    .action-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }
    
    .action-card summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
    }
    
    .action-card summary::-webkit-details-marker {
      display: none;
    }
    
    .form--stack {
      margin-top: 16px;
      display: grid;
      gap: 12px;
    }
    
    .form--stack label {
      display: grid;
      gap: 4px;
    }
    
    .button--danger {
      background: var(--error);
    }
    
    .button--danger:hover {
      background: #b91c1c;
    }
    
    details[open] summary.button {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <header class="hero">
      <div class="brand">
        <span class="brand__logo">NB</span>
        <div>
          <p class="brand__title">Navbook</p>
          <p class="brand__subtitle">Личный дневник заявок</p>
        </div>
      </div>
      <div class="hero__actions">
        <span class="hero__user">user@example.com</span>
        <a class="button button--ghost" href="/navbooks">Мои задачи</a>
        <a class="button button--ghost" href="/logout">Выйти</a>
      </div>
    </header>

    <!-- Flash messages -->
    <div class="flash flash--success">
      Добро пожаловать в Navbook!
    </div>

    <!-- Main content -->
    <main class="content">
      <section class="dashboard">
        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <p class="stat-label">Всего задач</p>
            <p class="stat-value">12</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Выполнено</p>
            <p class="stat-value">5</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">В работе</p>
            <p class="stat-value">7</p>
          </div>
        </div>

        <!-- Task creation panel -->
        <div class="panel">
          <h2>Создание задачи</h2>
          <div class="action-grid">
            <details class="action-card" open>
              <summary class="button button--primary">Создать задачу</summary>
              <form class="form" action="/navbooks/create" method="post" data-task-create>
                <label>
                  Название
                  <input type="text" name="title" placeholder="Например, подготовить отчёт" required />
                </label>
                <label>
                  Описание
                  <input type="text" name="description" placeholder="Что нужно сделать" />
                </label>
                <label>
                  Срок
                  <input type="date" name="due_date" />
                </label>
                <button class="button" type="submit">Сохранить</button>
              </form>
            </details>
            <details class="action-card">
              <summary class="button button--ghost">Удалить по ID</summary>
              <form class="form" action="/navbooks/delete" method="post" data-task-delete-id>
                <label>
                  ID задачи
                  <input type="number" name="task_id" min="1" placeholder="Например, 12" required />
                </label>
                <button class="button button--danger" type="submit">Удалить заявку</button>
              </form>
            </details>
          </div>
        </div>

        <!-- Tasks table -->
        <div class="panel">
          <h2>Таблица задач</h2>
          
          <!-- Tasks list -->
          <div class="table-wrapper">
            <table class="task-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Тип</th>
                  <th>Название</th>
                  <th>Описание</th>
                  <th>Срок</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                <!-- Task 1: Выполненная -->
                <tr>
                  <td>1</td>
                  <td>
                    <span class="status status--done">
                      Выполнена
                    </span>
                  </td>
                  <td>Подготовить отчет по проекту</td>
                  <td>Собрать данные за последний месяц и подготовить презентацию</td>
                  <td>2025-02-10</td>
                  <td>
                    <details>
                      <summary class="button button--ghost">Редактировать</summary>
                      <form class="form form--stack" action="/navbooks/1/edit" method="post" data-task-edit="1">
                        <label>
                          Название
                          <input type="text" name="title" value="Подготовить отчет по проекту" />
                        </label>
                        <label>
                          Описание
                          <input type="text" name="description" value="Собрать данные за последний месяц и подготовить презентацию" />
                        </label>
                        <label>
                          Срок
                          <input type="date" name="due_date" value="2025-02-10" />
                        </label>
                        <label>
                          <input type="checkbox" name="is_done" checked />
                          Выполнена
                        </label>
                        <button class="button button--primary" type="submit">Сохранить</button>
                      </form>
                    </details>
                    <form class="inline-form" action="/navbooks/1/delete" method="post" data-task-delete="1">
                      <button class="button button--danger" type="submit">Удалить</button>
                    </form>
                  </td>
                </tr>
                
                <!-- Task 2: В работе -->
                <tr>
                  <td>2</td>
                  <td>
                    <span class="status status--pending">
                      В работе
                    </span>
                  </td>
                  <td>Разработать макет главной страницы</td>
                  <td>Создать прототип в Figma, согласовать с дизайнером</td>
                  <td>2025-02-15</td>
                  <td>
                    <details>
                      <summary class="button button--ghost">Редактировать</summary>
                      <form class="form form--stack" action="/navbooks/2/edit" method="post" data-task-edit="2">
                        <label>
                          Название
                          <input type="text" name="title" value="Разработать макет главной страницы" />
                        </label>
                        <label>
                          Описание
                          <input type="text" name="description" value="Создать прототип в Figma, согласовать с дизайнером" />
                        </label>
                        <label>
                          Срок
                          <input type="date" name="due_date" value="2025-02-15" />
                        </label>
                        <label>
                          <input type="checkbox" name="is_done" />
                          Выполнена
                        </label>
                        <button class="button button--primary" type="submit">Сохранить</button>
                      </form>
                    </details>
                    <form class="inline-form" action="/navbooks/2/delete" method="post" data-task-delete="2">
                      <button class="button button--danger" type="submit">Удалить</button>
                    </form>
                  </td>
                </tr>
                
                <!-- Task 3: Просроченная -->
                <tr>
                  <td>3</td>
                  <td>
                    <span class="status status--pending">
                      В работе
                    </span>
                  </td>
                  <td>Обновить документацию API</td>
                  <td>Добавить описание новых эндпоинтов</td>
                  <td>2025-02-05</td>
                  <td>
                    <details>
                      <summary class="button button--ghost">Редактировать</summary>
                      <form class="form form--stack" action="/navbooks/3/edit" method="post" data-task-edit="3">
                        <label>
                          Название
                          <input type="text" name="title" value="Обновить документацию API" />
                        </label>
                        <label>
                          Описание
                          <input type="text" name="description" value="Добавить описание новых эндпоинтов" />
                        </label>
                        <label>
                          Срок
                          <input type="date" name="due_date" value="2025-02-05" />
                        </label>
                        <label>
                          <input type="checkbox" name="is_done" />
                          Выполнена
                        </label>
                        <button class="button button--primary" type="submit">Сохранить</button>
                      </form>
                    </details>
                    <form class="inline-form" action="/navbooks/3/delete" method="post" data-task-delete="3">
                      <button class="button button--danger" type="submit">Удалить</button>
                    </form>
                  </td>
                </tr>
                
                <!-- Task 4: Ежедневная задача -->
                <tr>
                  <td>4</td>
                  <td>
                    <span class="status status--pending">
                      В работе
                    </span>
                  </td>
                  <td>Daily stand-up</td>
                  <td>Утренняя встреча команды</td>
                  <td>2025-02-11</td>
                  <td>
                    <details>
                      <summary class="button button--ghost">Редактировать</summary>
                      <form class="form form--stack" action="/navbooks/4/edit" method="post" data-task-edit="4">
                        <label>
                          Название
                          <input type="text" name="title" value="Daily stand-up" />
                        </label>
                        <label>
                          Описание
                          <input type="text" name="description" value="Утренняя встреча команды" />
                        </label>
                        <label>
                          Срок
                          <input type="date" name="due_date" value="2025-02-11" />
                        </label>
                        <label>
                          <input type="checkbox" name="is_done" />
                          Выполнена
                        </label>
                        <button class="button button--primary" type="submit">Сохранить</button>
                      </form>
                    </details>
                    <form class="inline-form" action="/navbooks/4/delete" method="post" data-task-delete="4">
                      <button class="button button--danger" type="submit">Удалить</button>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Empty state (закомментирован, пока есть задачи) -->
          <!-- <p class="muted">Пока нет задач. Создайте первую.</p> -->
        </div>
      </section>
    </main>
  </div>

  <script>
    const sendRequest = async (url, options) => {
      const response = await fetch(url, {
        credentials: "include",
        headers: { 
          "Content-Type": "application/json" 
        },
        ...options
      });
      
      if (response.ok) {
        window.location.reload();
        return;
      }
      
      let message = "Произошла ошибка.";
      try {
        const data = await response.json();
        if (data?.detail) {
          message = data.detail;
        }
      } catch (error) {
        // ignore json parse errors
      }
      alert(message);
    };

    const normalizeDate = (value) => (value ? `${value}T00:00:00` : undefined);

    // Create task form
    const createForm = document.querySelector("[data-task-create]");
    if (createForm) {
      createForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const data = new FormData(createForm);
        const payload = {
          title: data.get("title"),
          description: data.get("description") || undefined,
          due_date: normalizeDate(data.get("due_date"))
        };
        sendRequest("/tasks", {
          method: "POST",
          body: JSON.stringify(payload)
        });
      });
    }

    // Edit task forms
    document.querySelectorAll("[data-task-edit]").forEach((form) => {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const data = new FormData(form);
        const taskId = form.dataset.taskEdit;
        const payload = {
          title: data.get("title"),
          description: data.get("description") || undefined,
          due_date: normalizeDate(data.get("due_date")),
          is_done: data.get("is_done") === "on"
        };
        sendRequest(`/tasks/${taskId}`, {
          method: "PATCH",
          body: JSON.stringify(payload)
        });
      });
    });

    // Delete task forms
    document.querySelectorAll("[data-task-delete]").forEach((form) => {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const taskId = form.dataset.taskDelete;
        if (confirm("Удалить задачу?")) {
          sendRequest(`/tasks/${taskId}`, { 
            method: "DELETE" 
          });
        }
      });
    });

    // Delete by ID form
    const deleteByIdForm = document.querySelector("[data-task-delete-id]");
    if (deleteByIdForm) {
      deleteByIdForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const data = new FormData(deleteByIdForm);
        const taskId = data.get("task_id");
        if (!taskId) {
          alert("Введите ID задачи.");
          return;
        }
        if (confirm(`Удалить задачу с ID ${taskId}?`)) {
          sendRequest(`/tasks/${taskId}`, { 
            method: "DELETE" 
          });
        }
      });
    }

    // Set min date for date inputs
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
      input.min = today;
    });
  </script>
</body>
</html>